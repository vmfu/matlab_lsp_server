# Архитектура LSP MATLAB Server для Windows

## Обзор проекта

LSP MATLAB Server - это реализация Language Server Protocol (LSP) для языка программирования MATLAB, предназначенная для работы на платформе Windows. Сервер обеспечивает интеллектуальные возможности редактирования кода MATLAB в различных редакторах, включая TUI Crush.

## Технологический стек

### Основные технологии

| Компонент | Технология | Назначение |
|-----------|------------|------------|
| **LSP Framework** | pygls (Python) | Библиотека для создания Language Server |
| **Python** | 3.10+ | Основной язык реализации |
| **Анализ кода MATLAB** | MATLAB mlint.exe | Статический анализ кода MATLAB |
| **Парсинг кода** | tree-sitter-matlab / regex | Парсинг MATLAB синтаксиса |

### Зависимости

```python
# Основные зависимости
pygls>=0.13.0              # LSP framework
lsprotocol>=2023.0.0      # LSP протокол типы
```

> **Использование интеллектуальных инструментов**: Для определения оптимальных зависимостей и версий библиотек используются инструменты анализа экосистемы Python, такие как агенты для поиска и анализа документации на PyPI и GitHub, а также MCP инструменты:
> - **z_ai MCP** - для генерации и анализа кода
> - **context7 MCP** - для получения актуальной документации по библиотекам
> - **DuckDuckGo MCP** - для поиска в интернете
> - **Filesystem MCP** - для анализа файлов проекта

## Архитектурные компоненты

```
┌─────────────────────────────────────────────────────────────────┐
│                         LSP Client (TUI Crush)                  │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │ JSON-RPC
                              │ (stdin/stdout)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   MATLAB LSP Server (pygls)                     │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   Protocol   │  │   Features   │  │     Handlers         │  │
│  │   Layer      │  │   Manager    │  │     (LSP methods)    │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │    Parser    │  │   Analyzer   │  │   Cache Manager      │  │
│  │   MATLAB     │  │   (mlint)    │  │                      │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ Symbol Table │  │ Indexer      │  │   Config Manager     │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │ Process execution
                              │
┌─────────────────────────────────────────────────────────────────┐
│              MATLAB Installation (mlint.exe)                     │
└─────────────────────────────────────────────────────────────────┘
```

## Подробное описание компонентов

### 1. Protocol Layer (Слой протокола)

**Назначение**: Обработка LSP сообщений и координация работы сервера

**Ответственности**:
- Инициализация и завершение работы сервера (`initialize`, `shutdown`, `exit`)
- Управление возможностями сервера (Server Capabilities)
- Обработка lifecycle событий

**Ключевые файлы**:
- `server.py` - Главная точка входа, настройка LSP сервера
- `protocol/` - Модули для обработки протокольных сообщений

```python
# Пример структуры
class MatLSServer(LanguageServer):
    """Основной класс LSP сервера для MATLAB"""
```

### 2. Features Manager (Менеджер возможностей)

**Назначение**: Регистрация и управление LSP возможностями

**Поддерживаемые возможности**:

| Возможность | Статус | Описание |
|-------------|--------|----------|
| `textDocument/completion` | ✅ Запланировано | Автодополнение кода |
| `textDocument/hover` | ✅ Запланировано | Информация при наведении |
| `textDocument/definition` | ✅ Запланировано | Переход к определению |
| `textDocument/references` | ✅ Запланировано | Поиск использований |
| `textDocument/diagnostic` | ✅ Приоритет | Диагностика ошибок |
| `textDocument/documentSymbol` | ✅ Запланировано | Структура документа |
| `textDocument/codeAction` | ✅ Запланировано | Исправления кода |
| `textDocument/formatting` | ✅ Запланировано | Форматирование |
| `workspace/symbol` | ✅ Запланировано | Поиск символов |

> **Использование интеллектуальных инструментов**: Для определения приоритетов и последовательности реализации возможностей используются агенты для анализа существующих MATLAB LSP реализаций и лучших практик разработки LSP серверов. В проекте активно применяются MCP инструменты:
> - **z_ai MCP** - для генерации шаблонов кода LSP хендлеров
> - **context7 MCP** - для получения документации по pygls и LSP спецификации
> - **z_ai_tools MCP** - для анализа архитектурных диаграмм и технической документации

### 3. Handlers (Обработчики LSP методов)

**Назначение**: Реализация конкретных LSP методов

**Структура директории**:
```
handlers/
├── __init__.py
├── completion.py      # Обработка автодополнения
├── diagnostics.py     # Диагностика ошибок
├── hover.py           # Информация при наведении
├── definition.py      # Переход к определению
├── references.py      # Поиск ссылок
└── formatting.py      # Форматирование кода
```

### 4. MATLAB Parser (Парсер MATLAB)

**Назначение**: Парсинг MATLAB кода для извлечения информации

**Возможности**:
- Извлечение определений функций
- Поиск объявлений переменных
- Определение структуры классов
- Парсинг комментариев для документации

**Реализация**:
- Основной: regex паттерны для MATLAB синтаксиса
- Расширенный: tree-sitter-matlab (если доступен)

```python
class MatlabParser:
    """Парсер MATLAB кода"""

    def parse_file(self, content: str) -> ParseResult:
        """Парсит содержимое .m файла"""

    def extract_functions(self, content: str) -> List[FunctionInfo]:
        """Извлекает определения функций"""

    def extract_variables(self, content: str) -> List[VariableInfo]:
        """Извлекает объявления переменных"""
```

> **Использование интеллектуальных инструментов**: Для разработки парсера MATLAB используются агенты для поиска и анализа существующих реализаций парсеров MATLAB на GitHub, а также исследования MATLAB синтаксиса в официальной документации. Применяем MCP инструменты:
> - **z_ai MCP** - для генерации regex паттернов и парсинга
> - **context7 MCP** - для доступа к документации MATLAB
> - **z_ai_tools MCP** - для анализа примеров MATLAB кода и extraction из скриншотов

### 5. Analyzer (Анализатор)

**Назначение**: Интеграция с MATLAB инструментами статического анализа

**Основной инструмент**: `mlint.exe` из MATLAB

**Функционал**:
- Вызов mlint для анализа кода
- Парсинг вывода mlint
- Преобразование в LSP диагностики
- Кэширование результатов анализа

```python
class MlintAnalyzer:
    """Анализатор на основе MATLAB mlint"""

    def analyze(self, filepath: str) -> List[Diagnostic]:
        """Анализирует файл и возвращает диагностику"""

    def parse_mlint_output(self, output: str) -> List[Diagnostic]:
        """Парсит вывод mlint и конвертирует в LSP Diagnostic"""
```

### 6. Symbol Table (Таблица символов)

**Назначение**: Хранение и управление информацией о символах кода

**Типы символов**:
- Функции (локальные и глобальные)
- Переменные
- Классы
- Свойства классов
- Методы классов

**Индексация**:
- File-level индекс (символы в файле)
- Workspace-level индекс (символы проекта)

```python
class SymbolTable:
    """Таблица символов MATLAB проекта"""

    def add_symbols(self, uri: str, symbols: List[Symbol]):
        """Добавляет символы для документа"""

    def get_definition(self, uri: str, line: int, column: int) -> Optional[Location]:
        """Находит определение символа"""

    def find_references(self, uri: str, line: int, column: int) -> List[Location]:
        """Находит все использования символа"""

    def get_workspace_symbols(self, query: str) -> List[SymbolInformation]:
        """Поиск символов по имени"""
```

### 7. Cache Manager (Менеджер кэша)

**Назначение**: Оптимизация производительности через кэширование

**Уровни кэша**:
1. **Parse Cache** - результаты парсинга файлов
2. **Analysis Cache** - результаты mlint анализа
3. **Symbol Cache** - индекс символов
4. **Completion Cache** - результаты автодополнения

```python
class CacheManager:
    """Менеджер кэша для оптимизации"""

    def get_cached_parse(self, uri: str) -> Optional[ParseResult]:
        """Получает кэшированные результаты парсинга"""

    def invalidate(self, uri: str):
        """Инвалидирует кэш для файла"""
```

### 8. Config Manager (Менеджер конфигурации)

**Назначение**: Управление настройками сервера

**Конфигурация**:
- Путь к MATLAB (для mlint)
- Правила диагностики
- Настройки форматирования
- Исключения из анализа

```python
class ConfigManager:
    """Менеджер конфигурации"""

    def get_matlab_path(self) -> str:
        """Возвращает путь к MATLAB"""

    def get_diagnotic_rules(self) -> Dict[str, bool]:
        """Возвращает активные правила диагностики"""
```

## Потоки обработки данных

### Поток диагностики

```
Document Change (didChange)
        ↓
   Cache Check
        ↓
   Parse File
        ↓
   Run mlint
        ↓
   Parse Output
        ↓
   Convert to LSP Diagnostics
        ↓
   Publish Diagnostics
```

### Поток автодополнения

```
Completion Request
        ↓
   Get Cursor Position
        ↓
   Parse Context
        ↓
   Query Symbol Table
        ↓
   Filter Candidates
        ↓
   Rank Results
        ↓
   Return Completion Items
```

### Поток перехода к определению

```
Definition Request
        ↓
   Get Cursor Position
        ↓
   Parse Symbol
        ↓
   Search Symbol Table
        ↓
   Return Location
```

## Структура проекта

```
lsp_matlab_for_windows/
├── server.py                  # Главный файл сервера
├── requirements.txt           # Зависимости Python
├── setup.py                   # Установка пакета
├── src/
│   ├── __init__.py
│   ├── protocol/              # LSP протокол обработчики
│   │   ├── __init__.py
│   │   └── lifecycle.py
│   ├── handlers/              # LSP обработчики
│   │   ├── __init__.py
│   │   ├── completion.py
│   │   ├── diagnostics.py
│   │   ├── hover.py
│   │   ├── definition.py
│   │   ├── references.py
│   │   ├── formatting.py
│   │   └── symbols.py
│   ├── parser/                # Парсер MATLAB
│   │   ├── __init__.py
│   │   ├── matlab_parser.py
│   │   └── models.py
│   ├── analyzer/              # Анализаторы
│   │   ├── __init__.py
│   │   ├── mlint_analyzer.py
│   │   └── base_analyzer.py
│   ├── features/              # LSP возможности
│   │   ├── __init__.py
│   │   └── feature_manager.py
│   └── utils/                 # Утилиты
│       ├── __init__.py
│       ├── cache.py
│       ├── config.py
│       └── logging.py
├── tests/                     # Тесты
│   ├── unit/
│   ├── integration/
│   └── fixtures/
├── docs/                      # Документация
│   ├── ARCHITECTURE.md
│   ├── README.md
│   ├── DEVELOPMENT.md
│   ├── DOCUMENTATION.md
│   └── INTEGRATION.md
└── for_tests/                 # Тестовые MATLAB файлы
    ├── test_lsp_detailed.m
    └── test_matlab_lsp_simple.m
```

## Интеграция с TUI Crush

TUI Crush является LSP клиентом, который:
1. Запускает MATLAB LSP сервер как отдельный процесс
2. Отправляет JSON-RPC сообщения через stdin/stdout
3. Отображает диагностику и предоставляет функции редактирования

Подробная инструкция по интеграции находится в `INTEGRATION.md`.

## Производительность и оптимизация

### Стратегии оптимизации

1. **Кэширование**: Все результаты парсинга и анализа кэшируются
2. **Инкрементный анализ**: Только измененные файлы переанализируются
3. **Ленивая загрузка**: Индексация создается по требованию
4. **Параллельная обработка**: Несколько файлов анализируются параллельно
5. **Дебаунсинг**: События изменения файла группируются

### Метрики производительности

| Операция | Целевое время | Текущий статус |
|----------|---------------|----------------|
| Начальная инициализация | < 1с | Не реализовано |
| Парсинг файла (1KB) | < 50ms | Не реализовано |
| Анализ mlint (10KB) | < 500ms | Не реализовано |
| Автодополнение | < 100ms | Не реализовано |
| Диагностика файла | < 300ms | Не реализовано |

## Безопасность

1. **Валидация путей**: Все пути файлов проверяются
2. **Изоляция процессов**: MATLAB mlint запускается изолированно
3. **Ограничение ресурсов**: Лимиты на время выполнения и память
4. **Логирование**: Все операции логируются для аудита

## Расширяемость

Архитектура поддерживает добавление:
- Новых LSP возможностей
- Дополнительных анализаторов
- Альтернативных парсеров
- Новых источников документации
- Плагинов для интеграции с внешними инструментами

## Следующие шаги

1. [ ] Реализовать базовую структуру сервера
2. [ ] Интеграция с mlint для диагностики
3. [ ] Реализация парсера MATLAB
4. [ ] Таблица символов и индексация
5. [ ] Автодополнение кода
6. [ ] Переход к определению
7. [ ] Поиск использований
8. [ ] Форматирование кода
9. [ ] Интеграция с TUI Crush
10. [ ] Написание тестов и документации
